<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Mods è·³è½¬å™¨</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='30' fill='%23050510' stroke='%2300f3ff' stroke-width='2'/><path d='M24 18 L24 46 L20 46 L20 18 Z M24 18 L40 18 L40 22 L24 22 Z M20 42 L32 42 Q40 42 40 34 Q40 26 32 26 L28 26 L28 30 L32 30 Q36 30 36 34 Q36 38 32 38 L20 38 Z' fill='%2300f3ff'/></svg>" type="image/svg+xml">
    
    <script src="translations.js"></script>
    
    <style>
        /* --- æ ¸å¿ƒå˜é‡å®šä¹‰ --- */
        :root {
            --primary-color: #00f3ff;       /* éœ“è™¹é’ */
            --secondary-color: #ff0055;     /* éœ“è™¹ç´«çº¢ */
            --bg-color: #050510;            /* æ·±ç©ºé»‘è“ */
            --panel-bg: rgba(10, 15, 25, 0.85); /* é¢æ¿èƒŒæ™¯ */
            --text-main: #e0f7fa;           /* ä¸»æ–‡æœ¬ */
            --text-muted: #607d8b;          /* å¼±åŒ–æ–‡æœ¬ */
            --border-color: rgba(0, 243, 255, 0.3);
            --grid-color: rgba(0, 243, 255, 0.07);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            background-color: var(--bg-color);
            /* åŠ¨æ€ç½‘æ ¼èƒŒæ™¯ */
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center top;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            overflow-x: hidden;
            animation: backgroundScroll 20s linear infinite;
        }

        @keyframes backgroundScroll {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }

        /* --- ä¸»å®¹å™¨æ ·å¼ --- */
        .container {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 40px;
            max-width: 520px;
            width: 90%;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.05);
            position: relative;
            transform: translateY(0);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .container:hover {
            box-shadow: 0 0 60px rgba(0, 243, 255, 0.15);
            transform: translateY(-5px);
        }

        /* è£…é¥°æ€§è§’è½æ ‡è®° (Corner Markers) */
        .container::before, .container::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .container::before {
            top: -2px;
            left: -2px;
            border-right: none;
            border-bottom: none;
            box-shadow: -2px -2px 10px var(--primary-color);
        }

        .container::after {
            bottom: -2px;
            right: -2px;
            border-left: none;
            border-top: none;
            box-shadow: 2px 2px 10px var(--primary-color);
        }

        /* --- æ ‡é¢˜æ ·å¼ (Glitchæ•ˆæœ) --- */
        h1 {
            color: var(--primary-color);
            text-align: center;
            font-size: 2em;
            margin-bottom: 40px;
            text-transform: uppercase;
            letter-spacing: 3px;
            position: relative;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        h1::before, h1::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            opacity: 0.8;
        }

        h1::before {
            left: 2px;
            text-shadow: -1px 0 var(--secondary-color);
            clip: rect(24px, 550px, 90px, 0);
            animation: glitch-anim-2 3s infinite linear alternate-reverse;
        }

        h1::after {
            left: -2px;
            text-shadow: -1px 0 var(--primary-color);
            clip: rect(85px, 550px, 140px, 0);
            animation: glitch-anim 2.5s infinite linear alternate-reverse;
        }

        @keyframes glitch-anim {
            0% { clip: rect(10px, 9999px, 30px, 0); }
            20% { clip: rect(80px, 9999px, 100px, 0); }
            40% { clip: rect(40px, 9999px, 60px, 0); }
            60% { clip: rect(120px, 9999px, 140px, 0); }
            80% { clip: rect(60px, 9999px, 80px, 0); }
            100% { clip: rect(20px, 9999px, 40px, 0); }
        }
        @keyframes glitch-anim-2 {
            0% { clip: rect(60px, 9999px, 80px, 0); }
            20% { clip: rect(10px, 9999px, 30px, 0); }
            40% { clip: rect(100px, 9999px, 120px, 0); }
            60% { clip: rect(20px, 9999px, 40px, 0); }
            80% { clip: rect(80px, 9999px, 100px, 0); }
            100% { clip: rect(120px, 9999px, 140px, 0); }
        }

        /* --- è¡¨å•å…ƒç´  --- */
        .input-group {
            margin-bottom: 30px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.85em;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(0, 243, 255, 0.3);
        }

        input[type="text"] {
            width: 100%;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 16px;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(0, 0, 0, 0.7);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3), inset 0 0 10px rgba(0, 243, 255, 0.1);
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.2);
        }

        /* --- æŒ‰é’®æ ·å¼ --- */
        button {
            width: 100%;
            padding: 18px;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            font-size: 1.1em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-top: 10px;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
        }

        button:hover {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 30px var(--primary-color);
            transform: translateY(-2px);
            text-shadow: none;
        }

        button:active {
            transform: translateY(1px);
        }

        /* --- ä¸‹æ‹‰æœç´¢ç»“æœ --- */
        #search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(5, 8, 15, 0.98);
            border: 1px solid var(--primary-color);
            border-top: none;
            z-index: 100;
            display: none;
            box-shadow: 0 15px 30px rgba(0,0,0,0.8);
        }

        .game-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            color: #00f3ff;
        }

        .game-item:hover {
            background: rgba(0, 243, 255, 0.15);
            padding-left: 30px;
            color: #00ffff;
            text-shadow: 0 0 8px rgba(0, 243, 255, 0.6);
        }

        .game-item:hover::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .game-item.recent-game {
            border-left: 2px solid var(--secondary-color);
        }

        .game-item.recent-game:hover {
             border-left: 2px solid var(--primary-color);
        }

        #search-results::-webkit-scrollbar {
            width: 6px;
        }
        #search-results::-webkit-scrollbar-track {
            background: #000;
        }
        #search-results::-webkit-scrollbar-thumb {
            background: var(--primary-color);
        }

        /* --- å›¾æ ‡æŒ‰é’®ç»„ (å³ä¸Šè§’) --- */
        .top-icon {
            width: 45px !important;
            height: 45px !important;
            background: rgba(0, 0, 0, 0.6) !important;
            border: 1px solid var(--primary-color) !important;
            border-radius: 50% !important;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.15) !important;
            backdrop-filter: blur(5px) !important;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .top-icon:hover {
            background: rgba(0, 243, 255, 0.2) !important;
            box-shadow: 0 0 25px rgba(0, 243, 255, 0.4) !important;
            transform: scale(1.1);
        }
        
        .top-icon svg, .top-icon span {
            filter: drop-shadow(0 0 5px rgba(0, 243, 255, 0.8));
        }

        /* CRT æ‰«æçº¿æ•ˆæœ */
        body::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 9999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 243, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            vertical-align: text-bottom;
            margin-right: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* åˆ·æ–°å›¾æ ‡æ—‹è½¬ */
        #refresh-icon.refreshing span {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        #refresh-icon.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            border-color: #555 !important;
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: var(--primary-color);
            font-family: 'Consolas', monospace;
            font-size: 12px;
            opacity: 0.7;
            pointer-events: none;
            z-index: 9998;
            text-shadow: 0 0 5px var(--primary-color);
        }
        .blink { animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* å“åº”å¼ */
        @media (max-width: 480px) {
            .container { padding: 25px; margin: 10px; }
            h1 { font-size: 1.8em; }
        }

        /* é¼ æ ‡è½¨è¿¹æ•ˆæœ - ä»…æ¡Œé¢è®¾å¤‡ */
        @media (hover: hover) and (pointer: fine) {
            .cursor-trail {
                position: fixed;
                pointer-events: none;
                z-index: 9997;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--primary-color);
                box-shadow: 0 0 15px var(--primary-color), 0 0 30px var(--primary-color);
                opacity: 1;
                animation: trailFade 0.6s ease-out forwards;
            }

            .cursor-trail.secondary {
                background: var(--secondary-color);
                box-shadow: 0 0 15px var(--secondary-color), 0 0 30px var(--secondary-color);
            }

            @keyframes trailFade {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                100% {
                    transform: scale(0.3);
                    opacity: 0;
                }
            }

            /* è‡ªå®šä¹‰å…‰æ ‡ */
            body {
                cursor: none;
            }

            .custom-cursor {
                position: fixed;
                pointer-events: none;
                z-index: 10000;
                mix-blend-mode: difference;
                display: block;
            }
        }

        /* ç§»åŠ¨è®¾å¤‡éšè—è‡ªå®šä¹‰å…‰æ ‡ */
        @media (hover: none) or (pointer: coarse) {
            body {
                cursor: auto;
            }
            
            .custom-cursor {
                display: none !important;
            }
        }

        .cursor-dot {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .cursor-ring {
            width: 30px;
            height: 30px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.15s ease;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
        }

        .cursor-ring.hover {
            width: 30px;
            height: 30px;
            border-color: var(--secondary-color);
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.5);
        }

        a, button, input, .game-item, .top-icon {
            cursor: none !important;
        }
    </style>
</head>

<body>
    <!-- è‡ªå®šä¹‰å…‰æ ‡ -->
    <div class="custom-cursor" id="custom-cursor">
        <div class="cursor-dot"></div>
        <div class="cursor-ring" id="cursor-ring"></div>
    </div>

    <div style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
        <div id="github-icon" class="top-icon" title="è®¿é—®GitHubä»“åº“">
            <svg style="width: 24px; height: 24px; fill: #00f3ff; transition: transform 0.3s ease;" viewBox="0 0 24 24">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
        </div>
    </div>

    <div style="position: fixed; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 1000;">
        <div id="clear-history-icon" class="top-icon" title="æ¸…é™¤æœç´¢å†å²è®°å½•">
            <span style="color: #00f3ff; font-size: 20px;">ğŸ—‘ï¸</span>
        </div>
        <div id="refresh-icon" class="top-icon" title="å¼ºåˆ¶åˆ·æ–°æ¸¸æˆåˆ—è¡¨ç¼“å­˜">
            <span style="color: #00f3ff; font-size: 20px;">ğŸ”„</span>
        </div>
    </div>

    <div class="container">
        <h1 data-text="Nexus Mods è·³è½¬å™¨">Nexus Mods è·³è½¬å™¨</h1>

        <div class="input-group">
            <label for="game-search">æ¸¸æˆåç§° (DATABASE)</label>
            <input type="text" id="game-search" placeholder="æ­£åœ¨åˆå§‹åŒ–è¿æ¥..." autocomplete="off" disabled>
            <div id="search-results"></div>
            <div id="loading-indicator" style="text-align: center; margin-top: 10px; color: #00f3ff; font-size: 0.9em;">
                <span class="loading"></span> æ­£åœ¨ä» Nexus ç½‘ç»œè·å–æ•°æ®...
            </div>
        </div>

        <div class="input-group">
            <label for="mod-id">Mod ID (NUMERIC)</label>
            <input type="text" id="mod-id" placeholder="è¾“å…¥Modæ•°å­—ID">
        </div>

        <button id="go-button">è·³è½¬åˆ°Modé¡µé¢</button>
    </div>

    <div class="status-bar" id="status-bar">
        SYSTEM: <span id="status-text">CHECKING</span> <span class="blink">_</span>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®
        let games = [];

        // ç¼“å­˜é…ç½®
        const CACHE_CONFIG = {
            GAMES_CACHE_KEY: 'nexus_games_cache',
            CACHE_DURATION: 24 * 60 * 60 * 1000,
            CACHE_VERSION: '1.0'
        };

        // å†å²è®°å½•é…ç½®
        const HISTORY_CONFIG = {
            RECENT_GAMES_KEY: 'nexus_recent_games',
            MAX_RECENT_GAMES: 10
        };

        // --- å†å²è®°å½•ç®¡ç† ---
        function getRecentGames() {
            try {
                const data = localStorage.getItem(HISTORY_CONFIG.RECENT_GAMES_KEY);
                return data ? JSON.parse(data) : [];
            } catch (error) { return []; }
        }

        function addRecentGame(game) {
            try {
                let recent = getRecentGames();
                recent = recent.filter(g => g.slug !== game.slug);
                recent.unshift({
                    name: game.name,
                    chinese: game.chinese,
                    slug: game.slug,
                    downloads: game.downloads,
                    files: game.files,
                    timestamp: new Date().getTime()
                });
                if (recent.length > HISTORY_CONFIG.MAX_RECENT_GAMES) {
                    recent = recent.slice(0, HISTORY_CONFIG.MAX_RECENT_GAMES);
                }
                localStorage.setItem(HISTORY_CONFIG.RECENT_GAMES_KEY, JSON.stringify(recent));
                return true;
            } catch (error) { return false; }
        }

        function clearRecentGames() {
            try {
                localStorage.removeItem(HISTORY_CONFIG.RECENT_GAMES_KEY);
                return true;
            } catch (error) { return false; }
        }

        // --- ç¼“å­˜ç®¡ç† ---
        function isCacheValid() {
            try {
                const data = localStorage.getItem(CACHE_CONFIG.GAMES_CACHE_KEY);
                if (!data) return false;
                const cache = JSON.parse(data);
                if (cache.version !== CACHE_CONFIG.CACHE_VERSION) return false;
                if ((new Date().getTime() - cache.timestamp) > CACHE_CONFIG.CACHE_DURATION) return false;
                return true;
            } catch (error) { return false; }
        }

        function loadGamesFromCache() {
            try {
                const data = localStorage.getItem(CACHE_CONFIG.GAMES_CACHE_KEY);
                if (!data) return null;
                return JSON.parse(data).games;
            } catch (error) { return null; }
        }

        function saveGamesToCache(gamesList) {
            try {
                const data = {
                    games: gamesList,
                    timestamp: new Date().getTime(),
                    version: CACHE_CONFIG.CACHE_VERSION
                };
                localStorage.setItem(CACHE_CONFIG.GAMES_CACHE_KEY, JSON.stringify(data));
            } catch (error) { }
        }

        function clearGamesCache() {
            try { localStorage.removeItem(CACHE_CONFIG.GAMES_CACHE_KEY); } catch (error) { }
        }

        // --- æ ¸å¿ƒ API è¯·æ±‚é€»è¾‘ (å·²ä¿®å¤) ---
        async function fetchGamesFromAPI(forceRefresh = false) {
            const gameSearchInput = document.getElementById('game-search');
            const loadingIndicator = document.getElementById('loading-indicator');

            // 1. å°è¯•è¯»å–ç¼“å­˜
            if (!forceRefresh && isCacheValid()) {
                const cachedGames = loadGamesFromCache();
                if (cachedGames && cachedGames.length > 0) {
                    // é‡æ–°åº”ç”¨ç¿»è¯‘
                    games = cachedGames.map(game => ({
                        ...game,
                        chinese: (window.gameTranslations && window.gameTranslations[game.name]) || game.chinese || game.name
                    }));
                    
                    finalizeLoading(gameSearchInput, loadingIndicator, `å·²ä»ç¼“å­˜åŠ è½½ ${games.length} ä¸ªæ¸¸æˆ ğŸ’¾`, 'info');
                    return;
                }
            }

            // 2. æ‰§è¡ŒçœŸå®ç½‘ç»œè¯·æ±‚
            try {
                showNotification(forceRefresh ? 'æ­£åœ¨åˆ·æ–°æ¸¸æˆåˆ—è¡¨...' : 'æ­£åœ¨åŠ è½½æ¸¸æˆåˆ—è¡¨...', 'info');
                
                let response;
                try {
                    // å°è¯•ä¸» API
                    response = await fetch('/.netlify/functions/games', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                } catch (mainApiError) {
                    console.warn('ä¸» API å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ API:', mainApiError);
                    // å°è¯•å¤‡ç”¨ API
                    response = await fetch('/.netlify/functions/games-backup', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                }

                if (!response || !response.ok) {
                    throw new Error(response ? `HTTP ${response.status}` : 'API Connection Failed');
                }

                const apiGames = await response.json();

                // æ•°æ®è½¬æ¢ä¸ç¿»è¯‘
                games = apiGames.map(game => {
                    const chineseName = (window.gameTranslations && window.gameTranslations[game.name]) || game.name;
                    return {
                        name: game.name,
                        chinese: chineseName,
                        slug: game.domain_name,
                        categories: game.categories || 0,
                        downloads: game.downloads || 0,
                        files: game.file_count || 0
                    };
                });

                // æ’åºï¼šçƒ­é—¨åœ¨å‰
                games.sort((a, b) => b.downloads - a.downloads);

                // ä¿å­˜ç¼“å­˜
                saveGamesToCache(games);
                
                finalizeLoading(gameSearchInput, loadingIndicator, `æˆåŠŸåŠ è½½ ${games.length} ä¸ªæ¸¸æˆ ğŸ”„`, 'success');

            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆåˆ—è¡¨å¤±è´¥:', error);
                
                // å¤±è´¥åçš„é™çº§å¤„ç†ï¼šå°è¯•ä½¿ç”¨è¿‡æœŸç¼“å­˜æˆ–å¤‡ç”¨åˆ—è¡¨
                const cachedGames = loadGamesFromCache();
                if (cachedGames && cachedGames.length > 0) {
                    games = cachedGames.map(game => ({
                        ...game,
                        chinese: (window.gameTranslations && window.gameTranslations[game.name]) || game.chinese || game.name
                    }));
                    finalizeLoading(gameSearchInput, loadingIndicator, 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®', 'warning');
                } else if (window.fallbackGames) {
                     games = window.fallbackGames.map(game => ({
                        ...game,
                        chinese: (window.gameTranslations && window.gameTranslations[game.name]) || game.chinese || game.name
                    }));
                    finalizeLoading(gameSearchInput, loadingIndicator, 'è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨åˆ—è¡¨', 'warning');
                } else {
                    finalizeLoading(gameSearchInput, loadingIndicator, 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                }
            }
        }

        function finalizeLoading(input, indicator, msg, type) {
            input.disabled = false;
            input.placeholder = 'è¾“å…¥æ¸¸æˆä¸­æ–‡åæˆ–è‹±æ–‡å...';
            if (indicator) indicator.style.display = 'none';
            showNotification(msg, type);

            const refreshIcon = document.getElementById('refresh-icon');
            if (refreshIcon) {
                refreshIcon.style.opacity = '1';
                refreshIcon.classList.remove('refreshing', 'disabled');
            }

            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            updateSystemStatus(type === 'success' || type === 'info');
        }

        // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
        function updateSystemStatus(isOnline) {
            const statusText = document.getElementById('status-text');
            if (statusText) {
                statusText.textContent = isOnline ? 'ONLINE' : 'OFFLINE';
                statusText.style.color = isOnline ? 'var(--primary-color)' : 'var(--secondary-color)';
            }
        }

        // --- UI äº¤äº’ä¸é€»è¾‘ ---
        const gameSearchInput = document.getElementById('game-search');
        const searchResults = document.getElementById('search-results');
        const modIdInput = document.getElementById('mod-id');
        const goButton = document.getElementById('go-button');
        let selectedGame = null;

        // æ˜¾ç¤ºæœç´¢ç»“æœ/å†å²
        function showRecentGames() {
            const recentGames = getRecentGames();
            if (recentGames.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            searchResults.innerHTML = '';

            recentGames.forEach(game => {
                createGameItem(game, true);
            });
            searchResults.style.display = 'block';
        }

        function createGameItem(game, isRecent = false) {
            const div = document.createElement('div');
            div.className = isRecent ? 'game-item recent-game' : 'game-item';
            if(isRecent) div.style.paddingLeft = '25px';

            const displayName = game.chinese === game.name ? game.name : game.chinese;
            
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <div style="font-weight:500;">${isRecent ? '<span style="color:#bc13fe;margin-right:5px;">ğŸ•’</span>' : ''} ${highlightMatch(displayName, gameSearchInput.value)}</div>
                    <div style="font-size:12px; color:#666; font-family:monospace;">
                        ${game.downloads ? 'ğŸ“¥ ' + formatNumber(game.downloads) : ''}
                    </div>
                </div>
            `;

            div.addEventListener('click', function () {
                selectGame(game);
            });
            searchResults.appendChild(div);
        }

        function selectGame(game) {
            selectedGame = game;
            addRecentGame(game);
            const displayName = game.chinese === game.name ? game.name : game.chinese;
            gameSearchInput.value = displayName;
            searchResults.style.display = 'none';
            updateButtonState();
        }

        function updateButtonState() {
            if (selectedGame && modIdInput.value.trim()) {
                const displayName = selectedGame.chinese === selectedGame.name ? selectedGame.name : selectedGame.chinese;
                goButton.textContent = `è·³è½¬åˆ° ${displayName}`;
                goButton.style.background = 'var(--primary-color)';
                goButton.style.color = '#000';
                goButton.style.boxShadow = '0 0 20px var(--primary-color)';
            } else {
                goButton.textContent = 'è·³è½¬åˆ°Modé¡µé¢';
                goButton.style.background = 'transparent';
                goButton.style.color = 'var(--primary-color)';
                goButton.style.boxShadow = '0 0 10px rgba(0, 243, 255, 0.1)';
            }
        }

        // æœç´¢åŒ¹é…é€»è¾‘
        gameSearchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase().trim();
            if (searchTerm.length < 1) { showRecentGames(); return; }

            // å¤šç»´åŒ¹é…
            const matchedGames = games.filter(game => {
                const en = game.name.toLowerCase();
                const zh = (game.chinese || "").toLowerCase();
                
                // ç›´æ¥åŒ…å«
                if (en.includes(searchTerm) || zh.includes(searchTerm)) return true;
                // å»é™¤ç¬¦å·
                const cleanEn = en.replace(/[:\-\s]/g, '');
                const cleanSearch = searchTerm.replace(/[:\-\s]/g, '');
                if (cleanEn.includes(cleanSearch)) return true;
                // ç¼©å†™åŒ¹é… (e.g. GTA)
                if (searchTerm.length >= 2) {
                    const initials = en.match(/\b\w/g);
                    if (initials && initials.join('').toLowerCase().includes(searchTerm)) return true;
                }
                return false;
            });

            // æ’åº
            matchedGames.sort((a, b) => {
                // ç®€å•æƒé‡ï¼šä¸‹è½½é‡
                return (b.downloads || 0) - (a.downloads || 0);
            });

            searchResults.innerHTML = '';
            if (matchedGames.length > 0) {
                matchedGames.slice(0, 20).forEach(game => createGameItem(game));
            } else {
                searchResults.innerHTML = '<div style="padding:15px; text-align:center; color:#666;">æœªæ‰¾åˆ°åŒ¹é…æ¸¸æˆ</div>';
            }
            searchResults.style.display = 'block';
        });

        // èšç„¦æ˜¾ç¤ºå†å²
        gameSearchInput.addEventListener('focus', function () {
            this.value = '';
            selectedGame = null;
            updateButtonState();
            showRecentGames();
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', function (e) {
            if (e.target !== gameSearchInput && e.target !== searchResults && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // IDè¾“å…¥ä¸æŒ‰é’®
        modIdInput.addEventListener('input', function () {
            this.value = this.value.replace(/[^0-9]/g, '');
            updateButtonState();
        });

        goButton.addEventListener('click', function () {
            const modId = modIdInput.value.trim();
            if (!selectedGame) { showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¸¸æˆ', 'warning'); return; }
            if (!modId) { showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„ Mod ID', 'warning'); return; }

            const originalText = goButton.innerHTML;
            goButton.innerHTML = '<span class="loading"></span> è·³è½¬ä¸­...';
            goButton.disabled = true;

            setTimeout(() => {
                const url = `https://www.nexusmods.com/${selectedGame.slug}/mods/${modId}`;
                window.open(url, '_blank');
                goButton.innerHTML = originalText;
                goButton.disabled = false;
                showNotification('å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€', 'success');
            }, 800);
        });

        // è¾…åŠ©å‡½æ•°
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function highlightMatch(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span style="color:var(--primary-color); font-weight:bold;">$1</span>');
        }

        function showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            let color = 'var(--primary-color)';
            if (type === 'error') color = '#ff0055';
            if (type === 'warning') color = '#bc13fe';

            notif.style.cssText = `
                position: fixed; top: 20px; right: 20px;
                padding: 15px 25px; background: rgba(10, 15, 30, 0.95);
                border-left: 4px solid ${color};
                color: #fff; font-weight: 600;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                transform: translateX(400px); transition: transform 0.3s ease;
                z-index: 99999; backdrop-filter: blur(5px);
            `;
            notif.textContent = message;
            document.body.appendChild(notif);

            setTimeout(() => notif.style.transform = 'translateX(0)', 50);
            setTimeout(() => {
                notif.style.transform = 'translateX(400px)';
                setTimeout(() => document.body.removeChild(notif), 300);
            }, 3000);
        }

        // æŒ‰é’®ç»‘å®š
        document.getElementById('github-icon').addEventListener('click', () => {
            window.open('https://github.com/llxo/nexusmodjumper', '_blank');
            showNotification('å·²æ‰“å¼€ GitHub ä»“åº“', 'info');
        });
        document.getElementById('clear-history-icon').addEventListener('click', () => {
            if(clearRecentGames()) {
                showNotification('å†å²è®°å½•å·²æ¸…é™¤', 'success');
                if(searchResults.style.display === 'block') searchResults.style.display = 'none';
            }
        });
        document.getElementById('refresh-icon').addEventListener('click', function() {
            if (this.classList.contains('refreshing') || this.classList.contains('disabled')) return;
            this.classList.add('refreshing', 'disabled');
            clearGamesCache();
            fetchGamesFromAPI(true);
        });

        // ç²’å­èƒŒæ™¯
        function createParticles() {
            const count = 40;
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                const size = Math.random() * 3;
                const isCyan = Math.random() > 0.5;
                p.style.cssText = `
                    position:fixed; width:${size}px; height:${size}px;
                    background:${isCyan ? 'var(--primary-color)' : 'var(--secondary-color)'};
                    left:${Math.random()*100}vw; top:${Math.random()*100}vh;
                    opacity:${Math.random()*0.5}; pointer-events:none; z-index:-1;
                    box-shadow: 0 0 ${Math.random()*10}px ${isCyan ? 'var(--primary-color)' : 'var(--secondary-color)'};
                    transition: top 5s linear, opacity 2s ease;
                `;
                document.body.appendChild(p);
                animateParticle(p);
            }
        }
        function animateParticle(p) {
            setInterval(() => {
                p.style.top = Math.random() * window.innerHeight + 'px';
                p.style.left = Math.random() * window.innerWidth + 'px';
                p.style.opacity = Math.random() * 0.5;
            }, 3000 + Math.random() * 5000);
        }

        // é¼ æ ‡è½¨è¿¹æ•ˆæœ - ä»…æ¡Œé¢è®¾å¤‡å¯ç”¨
        function isDesktopDevice() {
            return window.matchMedia('(hover: hover) and (pointer: fine)').matches;
        }

        if (isDesktopDevice()) {
            let lastTrailTime = 0;
            const trailDelay = 30; // è½¨è¿¹é—´éš”ï¼ˆæ¯«ç§’ï¼‰
            
            document.addEventListener('mousemove', (e) => {
                const currentTime = Date.now();
                
                // æ›´æ–°è‡ªå®šä¹‰å…‰æ ‡ä½ç½®
                const customCursor = document.getElementById('custom-cursor');
                if (customCursor) {
                    customCursor.style.left = e.clientX + 'px';
                    customCursor.style.top = e.clientY + 'px';
                }
                
                // åˆ›å»ºè½¨è¿¹ç²’å­
                if (currentTime - lastTrailTime > trailDelay) {
                    createTrailParticle(e.clientX, e.clientY);
                    lastTrailTime = currentTime;
                }
            });

            // æ‚¬åœæ•ˆæœ
            const hoverElements = document.querySelectorAll('a, button, input, .game-item, .top-icon');
            const cursorRing = document.getElementById('cursor-ring');
            
            hoverElements.forEach(el => {
                el.addEventListener('mouseenter', () => {
                    if (cursorRing) cursorRing.classList.add('hover');
                });
                el.addEventListener('mouseleave', () => {
                    if (cursorRing) cursorRing.classList.remove('hover');
                });
            });
        }

        function createTrailParticle(x, y) {
            if (!isDesktopDevice()) return; // ç§»åŠ¨è®¾å¤‡ç›´æ¥è¿”å›
            
            const trail = document.createElement('div');
            trail.className = Math.random() > 0.7 ? 'cursor-trail secondary' : 'cursor-trail';
            trail.style.left = x + 'px';
            trail.style.top = y + 'px';
            
            // æ·»åŠ éšæœºåç§»
            const offsetX = (Math.random() - 0.5) * 10;
            const offsetY = (Math.random() - 0.5) * 10;
            trail.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
            
            document.body.appendChild(trail);
            
            // åŠ¨ç”»ç»“æŸåç§»é™¤
            setTimeout(() => {
                if (trail.parentNode) {
                    document.body.removeChild(trail);
                }
            }, 600);
        }

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            createParticles();
            updateSystemStatus(false); // åˆå§‹çŠ¶æ€ä¸ºæ£€æŸ¥ä¸­
            fetchGamesFromAPI();
        });

        // å›è½¦é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement === gameSearchInput && searchResults.style.display === 'block') {
                    const first = searchResults.querySelector('.game-item');
                    if (first) first.click();
                } else if (document.activeElement === modIdInput || document.activeElement === gameSearchInput) {
                    goButton.click();
                }
            }
            if (e.key === 'Escape') searchResults.style.display = 'none';
        });
    </script>
</body>
</html>